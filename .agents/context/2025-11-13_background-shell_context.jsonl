{"source":"PLAN.md","summary":["Background shell plan requires AI-only shell commands, 60s foreground budget with auto backgrounding, Ctrl+R manual backgrounding, per-shell cards plus Shell panel with detailed statuses, minimal toolset (run/summary/log/kill/resume), and English-only UI copy."],"citation":"PLAN.md:1-35"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["BackgroundShellManager tracks every shell_id with status/ended_by metadata, enforces a 60s FOREGROUND_BUDGET autopromotion via apply_promotion, and exposes kill/resume/summary/log APIs wired to BackgroundShellEvent dispatch."],"citation":"codex-rs/core/src/background_shell/mod.rs:41-405"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["TUI chat reuses ShellCardData per shell_id, shows Ctrl+R hints for foreground shells, sends BackgroundShellControl::BackgroundRequest on Ctrl+R, and advertises Ctrl+Shift+S hotkey to open the Shell panel."],"citation":"codex-rs/tui/src/chatwidget.rs:375-525"}
{"source":"codex-rs/tui/src/shell_panel.rs","summary":["ShellPanelOverlay renders running/completed/failed tabs, dispatches kill/resume/background actions via AppEvent::CodexOp, and exposes list/detail/diagnostic views with English key hints."],"citation":"codex-rs/tui/src/shell_panel.rs:33-515"}
{"source":"cargo check -p codex-core (2025-11-13)","summary":["Workspace build currently fails: background_shell/mod.rs cannot move Copy-less enums and tries to initialize BackgroundShellEvent fields (status, friendly_label, command, last_log) that the compiled protocol type lacks, blocking codex-core and codex-tui tests."],"citation":"cargo check -p codex-core@2025-11-13"}
{"source":"codex-rs/tui/src/shell_panel.rs","summary":["ShellPanelOverlay tracks an esc_press_pending flag so Esc release-only terminals still close the overlay, exposes a test hook, and adds unit tests covering Esc fallback and required double-press behavior."],"citation":"codex-rs/tui/src/shell_panel.rs:44-824"}
{"source":"codex-rs/tui/src/chatwidget/tests.rs","summary":["Introduced a seed_running_shell helper plus a shell_indicator_focus_and_enter_open_panel test, so Down then Enter on the footer counter must focus it and fire AppEvent::OpenShellPanel."],"citation":"codex-rs/tui/src/chatwidget/tests.rs:272-460"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["BackgroundShellKillParams now carry an initiator, kill_process records ended_by based on user/agent/system and defaults reasons/messages accordingly."],"citation":"codex-rs/core/src/background_shell/mod.rs:342-420"}
{"source":"docs/advanced.md","summary":["Documented that shell_kill accepts an initiator hint so attribution in history stays accurate between agent/user/system."],"citation":"docs/advanced.md:20-29"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["ChatWidget now tracks suppressed_exec_calls so Exec cells aren\u2019t created for agent-launched background shells; only direct user commands produce Running/Ran cards."],"citation":"codex-rs/tui/src/chatwidget.rs:289-1190"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["Foreground shells now inherit a 65s execution timeout (60s budget + 5s grace) while background shells default to a 24h timeout, preventing premature termination."],"citation":"codex-rs/core/src/background_shell/mod.rs:41-155"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_run теперь требует явный timeout_ms >0, передаёт его в ExecParams и отклоняет вызовы без тайм-лимита."],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs:52-110"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["Foreground shell_run commands now block until completion or autopromotion via a Notify handle, and background promotions emit structured promoted_by metadata so the agent knows who moved the process."],"citation":"codex-rs/core/src/background_shell/mod.rs:200-420"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["apply_promotion теперь сразу сохраняет текст автоперевода в reason и запоминает promoted_by, чтобы shell_summary/события сообщали кто отправил процесс в фон без дополнительных запросов."],"citation":"codex-rs/core/src/background_shell/mod.rs:358-409"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["apply_shell_event обновляет одну карточку на shell_id: для Started очищает Reason, только не-Start события могут записать новое сообщение, promoted_by копируется из события, а лишние bullet-уведомления в истории больше не добавляются."],"citation":"codex-rs/tui/src/chatwidget.rs:408-466"}
{"source":"codex-rs/tui/src/history_cell.rs","summary":["ShellCardData хранит promoted_by и ended_by, выводит строки \"Promoted by\"/\"Ended by\" с человекочитаемыми актёрами и по-прежнему показывает Reason/Last log однажды на карточку."],"citation":"codex-rs/tui/src/history_cell.rs:1248-1387"}
{"source":"codex-rs/tui/src/shell_panel.rs","summary":["Shell panel detail/list получает promoted_by из ShellPanelEntry и показывает его рядом со статусами, сохраняя те же actor labels что и карточки."],"citation":"codex-rs/tui/src/shell_panel.rs:304-763"}
{"source":"codex-rs/tui/src/chatwidget/tests.rs","summary":["Добавлен тест shell_events_update_cards_without_extra_history_cells: проверяет отсутствие лишних history cells и корректное заполнение reason/promoted_by/ended_by при promoted/terminated событиях."],"citation":"codex-rs/tui/src/chatwidget/tests.rs:463-528"}
{"source":"shell_panel_demo.py","summary":["ASCII-прототип теперь повторяет финальный UX: футер показывает Ctrl+R background в подсказках, detail экран выводит Promoted by, а фейковые данные содержат promoted_by."],"citation":"shell_panel_demo.py:91-159"}
{"source":"codex-rs/tui/src/history_cell.rs","summary":["format_shell_command теперь вырезает оболочный префикс вроде 'bash -lc', карточки и панель показывают фактическую команду и tail (~2KiB/16 строк) вместо сырого bash."],"citation":"codex-rs/tui/src/history_cell.rs:1248-1417"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["apply_shell_event сохраняет снапшот ShellState и после Terminated добавляет в историю summary вроде 'Completed shell-1 (sleep 500)' или 'Kill ...', чтобы пользователь видел итог операции."],"citation":"codex-rs/tui/src/chatwidget.rs:408-485"}
{"source":"codex-rs/tui/src/shell_panel.rs","summary":["ShellPanelEntry теперь базируется на ShellState: вкладки сортируют по state.status, detail/tail экран показывает усечённый хвост и пометки Promoted/Ended by без 'bash -lc'."],"citation":"codex-rs/tui/src/shell_panel.rs:250-611"}
{"source":"codex-rs/shell-model/src/lib.rs","summary":["ShellState хранит общий снапшот shell процесса (label, tail, timestamps) и применяет события через apply_event; core и TUI теперь обмениваются единым serde-типом."],"citation":"codex-rs/shell-model/src/lib.rs:1-260"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_kill handler now rejects calls that omit both shell_id and pid before defaulting initiator=agent and delegating to BackgroundShellManager, so the model must always name a concrete target."],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs:168-190"}
{"source":"codex-rs/core/src/tools/spec.rs","summary":["Function spec for shell_kill exposes an optional pid property, relaxes required fields, and explicitly instructs agents to supply either shell_id or pid when stopping a process."],"citation":"codex-rs/core/src/tools/spec.rs:424-460"}
{"source":"codex-rs/tui/src/history_cell.rs","summary":["Shell cards derive their display label via shell_label_for_display (which strips bash -lc wrappers) and render inline completion summaries like 'Kill shell-3 (sleep 500)' instead of emitting separate history rows."],"citation":"codex-rs/tui/src/history_cell.rs:1262-1458"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["apply_shell_event now only refreshes the existing shell card/footer state—terminated/promoted events no longer append info bullets—guaranteeing one chat card per shell_id."],"citation":"codex-rs/tui/src/chatwidget.rs:410-455"}
{"source":"codex-rs/tui/src/shell_panel.rs","summary":["ShellPanelEntry::label() reuses shell_label_for_display so the overlay lists and detail panes show the friendly command (e.g., 'sleep 500') instead of 'bash -lc …'."],"citation":"codex-rs/tui/src/shell_panel.rs:721-739"}
{"source":"docs/advanced.md","summary":["Background-shell docs now state explicitly that shell_kill accepts either shell_id or pid, keeping the written guidance aligned with the new tool schema."],"citation":"docs/advanced.md:11-32"}
{"source":"codex-rs/mcp-server/src/codex_tool_runner.rs","summary":["MCP runner now treats ExecCommandPid events the same as other shell telemetry, forwarding them as notifications but otherwise ignoring them so the event loop stays exhaustive."],"citation":"codex-rs/mcp-server/src/codex_tool_runner.rs:240-315"}
{"source":"codex-rs/exec/src/event_processor_with_human_output.rs","summary":["EventProcessorWithHumanOutput logs ExecCommandPid events (and thus handles the new enum variant) by printing the reported PID alongside other exec telemetry."],"citation":"codex-rs/exec/src/event_processor_with_human_output.rs:66-147"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["Ctrl+R hint теперь появляется только если процесс реально в foreground-режиме (не промоутнут и не стартовал в фоне), благодаря helper'у should_show_ctrl_r_hint()."],"citation":"codex-rs/tui/src/chatwidget.rs:410-520"}
{"source":"codex-rs/tui/src/history_cell.rs","summary":["Карточки процессов отображают строку 'Mode: foreground/background', что позволяет сразу определить, как был запущен процесс."],"citation":"codex-rs/tui/src/history_cell.rs:1289-1352"}
{"source":"codex-rs/tui/src/chatwidget/tests.rs","summary":["Тест ctrl_r_hint_hidden_for_background_shells убеждается, что подсказка не появляется для процессов, стартовавших с start_mode=background."],"citation":"codex-rs/tui/src/chatwidget/tests.rs:468-540"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["В apply_shell_event вернули вывод финальной карточки-сводки: при Terminated добавляется history info cell вида 'Kill shell-1', сохраняя единственную основную карточку на процесс."],"citation":"codex-rs/tui/src/chatwidget.rs:410-520"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["register_process теперь форсирует таймаут не меньше профиля режима (65s для foreground, 24h для background), даже если агент передал меньший timeout_ms; большие значения сохраняются."],"citation":"codex-rs/core/src/background_shell/mod.rs:250-330"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["Добавлены тесты register_process_enforces_foreground/background_timeout_floor и register_process_respects_custom_timeouts_above_floor, подтверждающие новые правила."],"citation":"codex-rs/core/src/background_shell/mod.rs:975-1060"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["Terminated shell events теперь снова добавляют лаконичное info-сообщение (Kill/Completed …), обеспечивая единый канал уведомлений без дублирования карточек."],"citation":"codex-rs/tui/src/chatwidget.rs:412-459"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["Подсказка Ctrl+R зависит только от фактического режима (start_mode==foreground и статус running/pending), поэтому после перевода в фон она больше не всплывает."],"citation":"codex-rs/tui/src/chatwidget.rs:432-458"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["Минимальный timeout теперь всегда равен 24ч для обоих режимов: foreground получает 60с бюджет только на UI-уровне, а процесс не завершается из-за короткого exec-таймаута."],"citation":"codex-rs/core/src/background_shell/mod.rs:253-320"}
{"source":"codex-rs/exec/src/event_processor_with_jsonl_output.rs","summary":["JSONL event processor теперь явно игнорирует ExecCommandPid события, так что новые протокольные варианты не ломают сериализацию."],"citation":"codex-rs/exec/src/event_processor_with_jsonl_output.rs:107-146"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["Добавлен тест autopromotion_keeps_process_running_with_long_timeout: автоперевод foreground-задачи в фон не отменяет cancel_token и сохраняет длинный таймаут."],"citation":"codex-rs/core/src/background_shell/mod.rs:1121-1164"}
{"source":"docs/advanced.md","summary":["Документация описывает новую строку Mode и одноразовые Kill/Completed уведомления в Shell карточках."],"citation":"docs/advanced.md:11-20"}
{"source":"shell_panel_demo.py","summary":["ASCII демо Shell panel показывает Mode/summary строки, демонстрируя обновлённый UX для Mode и Kill уведомлений."],"citation":"shell_panel_demo.py:1-140"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["should_show_ctrl_r_hint теперь подавляет подсказку, если команда уже содержит '&' (санитизируется через format_shell_command), чтобы пользователи, запускающие процессы в фоне через ampersand, не получали ложный Ctrl+R."],"citation":"codex-rs/tui/src/chatwidget.rs:3322-3334"}
{"source":"codex-rs/tui/src/chatwidget/tests.rs","summary":["Добавлен тест ctrl_r_hint_hidden_for_ampersand_commands: моделирует foreground старт с 'sleep 5 &' и подтверждает, что подсказка скрыта."],"citation":"codex-rs/tui/src/chatwidget/tests.rs:520-556"}
{"source":"codex-rs/core/src/background_shell/mod.rs","summary":["Foreground бюджет теперь переопределяется через атомик FOREGROUND_BUDGET_MS и тестовый guard set_foreground_budget_for_tests(), что позволило эмулировать автоперевод без 60‑сек ожидания."],"citation":"codex-rs/core/src/background_shell/mod.rs:46-116"}
{"source":"background shell finalization","summary":["shell_run now infers start_mode from timeout and emits system notes for promotions/terminations, so headless clients learn who moved or completed a process without watching the panel.","RunUserShellCommand now returns a warning instead of executing !cmd, completing the cleanup phase and matching docs/PLAN."],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs; codex-rs/core/src/background_shell/mod.rs; codex-rs/core/src/codex.rs; docs/advanced.md; PLAN.md"}
{"source":"background shell structured notes","summary":["Promote/terminate events now send JSON-formatted system notes (shell_id, pid, exit_code, status) so the agent sees PID/exit without parsing logs."],"citation":"codex-rs/core/src/background_shell/mod.rs"}

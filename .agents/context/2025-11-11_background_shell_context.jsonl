{"source":"codex-rs/tui/src/chatwidget.rs","summary":["Autopromote tracking now deduplicates shell start/kill events, suppresses exec cells when promotions are inferred, and renders 'Shell Auto-Promoted/Kill' labels with pref hints","Kill descriptions strip quotes/bash prefixes so background toasts match user commands"],"citation":"codex-rs/tui/src/chatwidget.rs"}
{"source":"codex-rs/core/src/tools/spec.rs","summary":["Shell tool spec exposes run_in_background/description/bookmark fields and explains how to follow up with shell_summary/log/kill"],"citation":"codex-rs/core/src/tools/spec.rs"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_summary/log/kill tool descriptions now instruct agents to inspect/trim logs instead of repeating commands"],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs"}
{"source":"codex-rs/app-server/tests/common/mcp_process.rs","summary":["MCP test harness buffers pending JSON-RPC responses so raw event readers no longer race sendUserMessage replies"],"citation":"codex-rs/app-server/tests/common/mcp_process.rs"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["ChatWidget now tracks detached command labels so exec history recovers the original command instead of showing raw call_ids when background shell events remove the running entry."],"citation":"codex-rs/tui/src/chatwidget.rs"}
{"source":"codex-rs/tui/src/chatwidget/tests.rs","summary":["Added regression test covering detached command flows to ensure history renders 'Done (command)' even when ExecBegin metadata vanished."],"citation":"codex-rs/tui/src/chatwidget/tests.rs"}
{"source":"codex-rs/core/tests/common/lib.rs","summary":["Developer guidance, AGENTS instructions, and environment context helpers can now be trimmed generically via prefix checks so replayed payloads match expectations."],"citation":"codex-rs/core/tests/common/lib.rs"}
{"source":"codex-rs/core/tests/suite/compact.rs","summary":["Final turn assertions drop the injected guidance/instruction/environment messages before comparing user transcripts."],"citation":"codex-rs/core/tests/suite/compact.rs"}
{"source":"codex-rs/core/tests/suite/stream_error_allows_next_turn.rs","summary":["Test now waits for the StreamError event (current behavior) and matches follow-up mock requests using the exact JSON needle to avoid developer-guidance false positives."],"citation":"codex-rs/core/tests/suite/stream_error_allows_next_turn.rs"}
{"source":"codex-rs/core/tests/suite/approvals.rs","summary":["Introduced FileCreatedNoStdout expectation for danger-full-access cases where the CLI no longer echoes file content, keeping the file content assertion intact."],"citation":"codex-rs/core/tests/suite/approvals.rs"}
{"source":"codex-rs/core/tests/suite/tool_harness.rs","summary":["Shell tool harness test tolerates CRLF endings when verifying stdout, preventing regex failures across platforms."],"citation":"codex-rs/core/tests/suite/tool_harness.rs"}
{"source":"codex-rs/core/src/tasks/user_shell.rs","summary":["User shell bang-commands now detect trailing '&', 'nohup', and 'setsid', stripping them and forcing run_in_background so Codex tracks and can kill the job."],"citation":"codex-rs/core/src/tasks/user_shell.rs"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_summary/log outputs now include the real shell_id plus ready-to-copy shell_kill/shell_log commands, making remote process control unambiguous."],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["All background-shell toasts and history entries display the actual shell_id, and autopromote events highlight it so kill/log follow-ups are obvious."],"citation":"codex-rs/tui/src/chatwidget.rs"}
{"source":"docs/advanced.md","summary":["Background-shell section documents smart detection of nohup/& jobs and the new shell_id-focused summary output for easier AI control."],"citation":"docs/advanced.md"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["Background shell startup now accepts a consolidated BackgroundStartContext (session/turn/tracker/call_id/metadata) instead of 7 scalar args, eliminating clippy’s too_many_arguments warning and making future extensions safer."],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"codex-rs/core/src/tools/handlers/shell.rs","summary":["Shell handler builds BackgroundStartContext before invoking manager.start, so run_in_background jobs inherit the new API without duplicating wiring logic."],"citation":"codex-rs/core/src/tools/handlers/shell.rs"}
{"source":"codex-rs/tui/src/pager_overlay.rs","summary":["Overlay::BackgroundShell now stores Box<BackgroundShellScreen>, keeping enum size bounded and removing clippy’s large_enum_variant warning."],"citation":"codex-rs/tui/src/pager_overlay.rs"}
{"source":"codex-rs/tui/src/render/scroll_view.rs","summary":["Removed redundant if/else branch in scroll_to_line so clippy’s if_same_then_else warning is gone and intent is clearer."],"citation":"codex-rs/tui/src/render/scroll_view.rs"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_summary args now include include_completed/include_failed switches (defaults keep listing only running jobs), and shell_log exposes mode=tail|summary|diagnostic with tightened max_lines=120."],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["Guidance mentions the new shell_log modes (tail/summary/diagnostic) so the agent always uses chunked or quick diagnostic dumps instead of full logs."],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"docs/advanced.md","summary":["Background-shell docs explain the running-only default for shell_summary and the three shell_log modes, reinforcing chunked access expectations."],"citation":"docs/advanced.md"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["BACKGROUND_SHELL_AGENT_GUIDANCE now spells out that shell_summary defaults to running jobs and uses --completed/--failed (include_completed/include_failed) for history","Shell log guidance clarifies that mode=diagnostic prioritizes stderr snippets for quick triage"],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"docs/advanced.md","summary":["Background workflow docs instruct users to reach for shell_summary --completed/--failed (aliases for include_completed/include_failed) only when history is needed"],"citation":"docs/advanced.md"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["Tool specs describe --completed/--failed flag behavior and emphasize that shell_summary responds with running shells by default"],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_log mode=diagnostic now strips stdout and only shows the last stderr lines, falling back to log tail with an explicit notice when no stderr exists","Unit tests cover the stderr-preferring diagnostic output and fallback behavior"],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs"}
{"source":"codex-rs/core/src/tasks/user_shell.rs","summary":["extract_run_in_background_directive no longer unwraps the optional preceding byte; we now skip directives when the preceding character is non-whitespace via is_some_and"],"citation":"codex-rs/core/src/tasks/user_shell.rs"}
{"source":"codex-rs/core/tests/suite/user_shell_cmd.rs","summary":["Added end-to-end test user_shell_background_summary_log_and_kill that launches a background bang command, fetches Op::BackgroundShellSummary, polls logs, issues Kill, and confirms summaries/logs reflect the terminal state"],"citation":"codex-rs/core/tests/suite/user_shell_cmd.rs"}
{"source":"codex-rs/tui/src/command_label.rs","summary":["Introduced friendly_command_label helpers that strip bash/zsh wrappers, collapse whitespace, and add ellipses for long commands so every surface reuses the same normalization"],"citation":"codex-rs/tui/src/command_label.rs"}
{"source":"codex-rs/tui/src/background_process.rs","summary":["BackgroundProcess::command_display now prepends bookmarks and uses the normalized command text, so indicators/toasts/history consistently show `#bookmark · command`","command_preview() and indicator stats use the sanitized label, and tests updated accordingly"],"citation":"codex-rs/tui/src/background_process.rs"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["command_preview() now reuses the friendly label helper for exec cells, kill event parsing canonicalizes `Kill shell ...` descriptions, and shell start events always show `Command:` plus a separate Notes line"],"citation":"codex-rs/tui/src/chatwidget.rs"}
{"source":"codex-rs/core/src/command_label.rs","summary":["Added shared friendly_command_label_* helpers in codex-core that strip env/bash wrappers, drop leading `set -euo ...` prologs, normalize semicolons, and truncate long commands so every API/event gets the same human label"],"citation":"codex-rs/core/src/command_label.rs"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["Background shells now store sanitized command previews and adopt_existing reuses the friendly label instead of `promoted shell`, so summary/poll events ship human-friendly text"],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"codex-rs/core/src/tools/handlers/shell.rs","summary":["Foreground shell commands also use the shared label helper when registering running sessions, ensuring autopromote descriptions and kill events reuse the same normalized text"],"citation":"codex-rs/core/src/tools/handlers/shell.rs"}
{"source":"codex-rs/core/src/command_label.rs","summary":["Normalizer now strips shell/env wrappers, drops set -euo prologs, splits trailing semicolons, rejoins tokens without noisy quoting, and collapses whitespace so API events ship concise labels"],"citation":"codex-rs/core/src/command_label.rs"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["Background shell toasts and history entries no longer spam Ctrl+B hints; start/promote events only show Notes when they differ from the command"],"citation":"codex-rs/tui/src/chatwidget.rs"}
{"source":"codex-rs/tui/src/exec_cell/render.rs","summary":["Exec cells no longer render the Ctrl+R hint inline, keeping command headers compact"],"citation":"codex-rs/tui/src/exec_cell/render.rs"}
{"source":"codex-rs/core/src/command_label.rs","summary":["friendly_command_label_from_args now expands bash -lc scripts before heuristically quoting tokens so background shell labels read like real commands instead of `'for …'` blocks","tests cover long scripts and legacy kill descriptions, locking in the new quoting/truncation behavior"],"citation":"codex-rs/core/src/command_label.rs"}
{"source":"codex-rs/tui/src/background_process.rs","summary":["BackgroundProcessStore exposes latest_output_line so UI events can grab the freshest stderr line for failure summaries"],"citation":"codex-rs/tui/src/background_process.rs"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["Shell history entries now render as `Shell (command)`/`Done (…)`/`Failed (…)` with all detail lines dimmed","Kill/completion events reuse normalized labels, strip Ctrl+B hints, and show a short reason pulled from the latest log chunk"],"citation":"codex-rs/tui/src/chatwidget.rs"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_summary refreshes running sessions against the unified exec manager before filtering so finished shells drop out unless --completed/--failed is set"],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["adopt_existing now asks the unified exec manager for the session's real command label so command_preview stays accurate even when the model set a custom description","new helper pick_command_preview() prioritizes sanitized command labels, then description labels, then the legacy 'promoted shell' fallback; unit tests cover the priority"],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"codex-rs/core/src/unified_exec/session_manager.rs","summary":["UnifiedExecSessionManager exposes session_command_label(session_id) so other subsystems can retrieve the stored friendly command for running sessions"],"citation":"codex-rs/core/src/unified_exec/session_manager.rs"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["Background shells periodically pump stdout via pump_session_output so shell_log/summary always see fresh tails and status flips as soon as Unified Exec reports completion","shell_kill now detects already-finished sessions, emits user-friendly events, and distinguishes user-requested kills from shells that completed before the stop request"],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_summary now refreshes + pumps all running shells before producing entries, so 'running' ghosts disappear and tail lines stay current","shell_log proactively pumps its shell before reading the buffer, eliminating the stale output issue"],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["Kill events now parse metadata like '(user requested)'/'(already finished)' and render status lines (killed by user vs finished before kill) with hints in the detail block"],"citation":"codex-rs/tui/src/chatwidget.rs"}
{"source":"codex-rs/core/tests/suite/user_shell_cmd.rs","summary":["New regression test background_summary_marks_completion_without_manual_poll proves that summary alone transitions finished shells out of the running state"],"citation":"codex-rs/core/tests/suite/user_shell_cmd.rs"}
{"source":"codex-rs/core/src/codex.rs","summary":["notify_background_event now injects a system-level history note (ContentItem::OutputText) so the agent always sees background-shell actions, and the note is persisted to the rollout log"],"citation":"codex-rs/core/src/codex.rs"}
{"source":"codex-rs/core/src/foreground_shell.rs","summary":["Auto-promotions emit `Background shell … auto-promoted …` messages via notify_background_event, explicitly stating they exceeded the 10s budget"],"citation":"codex-rs/core/src/foreground_shell.rs"}
{"source":"codex-rs/core/src/codex.rs","summary":["Manual PromoteShell messages now state that the promotion was requested by the user, so the agent can distinguish manual vs automatic moves"],"citation":"codex-rs/core/src/codex.rs"}
{"source":"codex-rs/tui/src/chatwidget.rs","summary":["Background-event deduper now suppresses any start message that matched a running foreground command, so manual promotions no longer add an extra `Shell (…)` card next to the promotion entry","Autopromote start messages still tag shell IDs for later status rendering, but they no longer surface duplicate history entries"],"citation":"codex-rs/tui/src/chatwidget.rs"}
{"source":"codex-rs/tui/src/chatwidget/tests.rs","summary":["New manual_promotion_start_event_is_hidden regression ensures start events stay suppressed for user-triggered promotions so history never shows double Shell rows"],"citation":"codex-rs/tui/src/chatwidget/tests.rs"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["Background shells now emit completion notices whenever refresh/poll/log detect a finished session: mark_completed returns a bool, entries track completion_announced, and new BackgroundCompletionNotice drives notify_background_event so the model sees \"Done/Failed\" messages without rerunning commands"],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_summary and shell_log now forward completion notices returned by BackgroundShellManager (plus pump_session_output) so each call can emit \"Background shell … terminated\" events before showing refreshed data"],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs"}
{"source":"codex-rs/tui/src/chatwidget/tests.rs","summary":["Added completion_event_without_kill_renders_done_block to lock in that non-kill \"Background shell … terminated\" events create a single `Done (cmd)` history card with a completed status line"],"citation":"codex-rs/tui/src/chatwidget/tests.rs"}
{"source":"codex-rs/core/src/codex.rs","summary":["notify_background_event now supports an optional agent note so we keep the legacy UI string but inject richer system messages (e.g., 'User killed background shell …') into the model context"],"citation":"codex-rs/core/src/codex.rs"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["Background shells now track completion_announced + entry labels, emit BackgroundCompletionNotice notes, and differentiate ShellActionInitiator::{User,Agent} so kill/promote events can log who triggered them"],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"codex-rs/core/src/foreground_shell.rs","summary":["Auto-promotions now log a system note ('System auto-promoted …') that includes the normalized command label, so the agent can distinguish automatic moves from user actions"],"citation":"codex-rs/core/src/foreground_shell.rs"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["Start/promote events now embed the normalized command label directly in the event message ("Shell (sleep 50)") so TUI and the model see identical wording"],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"codex-rs/core/src/foreground_shell.rs","summary":["Auto-promote events include both the human-friendly label and descriptor (bookmark/description) in the same string, aligning UI + agent messages"],"citation":"codex-rs/core/src/foreground_shell.rs"}
{"source":"codex-rs/core/src/codex.rs","summary":["Manual promotions reuse the same label text for both the user-visible BackgroundEvent and the system note, keeping the Shell headline consistent across surfaces"],"citation":"codex-rs/core/src/codex.rs"}
{"source":"codex-rs/core/src/background_shell.rs","summary":["Background shells now track CompletionDisposition (natural vs killed by user/agent) and propagate it through summary/log snapshots, so every tool response includes an 'Ended by' explanation"],"citation":"codex-rs/core/src/background_shell.rs"}
{"source":"codex-rs/core/src/tools/handlers/background_shell.rs","summary":["shell_summary/shell_log/shell_log --mode diagnostic print an extra 'Ended by: …' line derived from completion metadata, letting the agent read who finished the process without extra polling"],"citation":"codex-rs/core/src/tools/handlers/background_shell.rs"}
{"source":"codex-rs/protocol/src/protocol.rs","summary":["BackgroundShellSummaryEntry gained an optional ended_by field so clients can render the same human-readable reason shown to the agent"],"citation":"codex-rs/protocol/src/protocol.rs"}
{"source":"codex-rs/tui/src/background_process.rs","summary":["TUI stores the new ended_by string from summary events, enabling future UI polish without recomputing causes"] ,"citation":"codex-rs/tui/src/background_process.rs"}
